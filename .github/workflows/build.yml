name: Build iStoreOS x86_64 with Cgroup

# 手动触发编译（不自动运行）
on:
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    steps:
      # 1. 检出仓库（必填）
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装编译依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      # 3. 克隆 iStoreOS 官方源码
      - name: Clone Source Code
        run: git clone --depth=1 https://github.com/istoreos/istoreos.git

      # 4. 更新并安装插件源
      - name: Update Feeds
        run: |
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 核心配置（目标+根目录+EXT4+UEFI+Docker+Cgroup）
      - name: Configure Firmware
        run: |
          cd istoreos
          # 基础目标配置（x86_64通用版）
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

          # 1. 设置根目录大小为2048MB（2GB）
          echo "CONFIG_TARGET_ROOTFS_PARTSIZE=2048" >> .config
          # 2. 启用EXT4文件系统支持
          echo "CONFIG_TARGET_ROOTFS_EXT4FS=y" >> .config
          echo "CONFIG_PACKAGE_kmod-fs-ext4=y" >> .config
          # 3. 启用UEFI启动支持
          echo "CONFIG_EFI_IMAGES=y" >> .config
          echo "CONFIG_PACKAGE_grub2-efi=y" >> .config
          echo "CONFIG_PACKAGE_efibootmgr=y" >> .config
          # 4. 预装Docker及依赖（完整Docker环境）
          echo "CONFIG_PACKAGE_docker=y" >> .config
          echo "CONFIG_PACKAGE_luci-app-docker=y" >> .config
          echo "CONFIG_PACKAGE_kmod-docker=y" >> .config
          echo "CONFIG_PACKAGE_containerd=y" >> .config
          echo "CONFIG_PACKAGE_runc=y" >> .config
          # 5. 保留你需要的IPTables Cgroup组件
          echo "CONFIG_kmod-ipt-cgroup=y" >> .config
          echo "CONFIG_iptables-mod-cgroup=y" >> .config
          echo "CONFIG_NETFILTER_XT_MATCH_CGROUP=y" >> .config

      # 6. 生成最终配置
      - name: Make Defconfig
        run: |
          cd istoreos
          make defconfig

      # 7. 下载依赖包（加速编译）
      - name: Download Packages
        run: |
          cd istoreos
          make download -j$(nproc)

      # 8. 开始编译固件
      - name: Build Firmware
        run: |
          cd istoreos
          make -j$(nproc) V=s

      # 9. 上传编译结果（包含固件+清单）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iStoreOS-x86_64-Cgroup-Docker-2048MB
          path: |
            istoreos/bin/targets/x86/64/*.img.gz
            istoreos/bin/targets/x86/64/*.manifest
            selected_packages.txt
