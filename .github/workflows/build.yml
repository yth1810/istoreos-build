name: Build iStoreOS x86_64 with Cgroup

# 手动触发编译（不自动运行）
on:
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    steps:
      # 1. 检出仓库（必填）
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装编译依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      # 3. 克隆 iStoreOS 官方源码
      - name: Clone Source Code
        run: git clone --depth=1 https://github.com/istoreos/istoreos.git

      # 4. 更新并安装插件源
      - name: Update Feeds
        run: |
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 配置编译目标（x86_64 通用版）
      - name: Configure Target
        run: |
          cd istoreos
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

      # 6. 启用 IPTables Cgroup 组件（核心配置）
      - name: Enable IPTables Cgroup
        run: |
          cd istoreos
          echo "CONFIG_kmod-ipt-cgroup=y" >> .config
          echo "CONFIG_iptables-mod-cgroup=y" >> .config
          echo "CONFIG_NETFILTER_XT_MATCH_CGROUP=y" >> .config

      # 7. 生成最终配置
      - name: Make Defconfig
        run: |
          cd istoreos
          make defconfig

      # 8. 下载依赖包（加速编译）
      - name: Download Packages
        run: |
          cd istoreos
          make download -j$(nproc)

      # 9. 开始编译固件
      - name: Build Firmware
        run: |
          cd istoreos
          make -j$(nproc) V=s

      # 10. 上传编译结果（下载用）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iStoreOS-x86_64-Cgroup
          path: istoreos/bin/targets/x86/64/*.img.gz
