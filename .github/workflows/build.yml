name: Build iStoreOS x86_64 with Cgroup

# 手动触发编译（不自动运行）
on:
  workflow_dispatch:

jobs:
  build-firmware:
    runs-on: ubuntu-22.04
    steps:
      # 1. 检出仓库（必填）
      - name: Checkout
        uses: actions/checkout@v4

      # 2. 安装编译依赖
      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gcc-multilib g++-multilib \
          gettext git libncurses-dev libssl-dev python3-distutils rsync unzip zlib1g-dev file wget

      # 3. 克隆 iStoreOS 官方源码
      - name: Clone Source Code
        run: git clone --depth=1 https://github.com/istoreos/istoreos.git

      # 4. 更新并安装插件源
      - name: Update Feeds
        run: |
          cd istoreos
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      # 5. 配置编译目标（x86_64 通用版）
      - name: Configure Target
        run: |
          cd istoreos
          echo "CONFIG_TARGET_x86=y" >> .config
          echo "CONFIG_TARGET_x86_64=y" >> .config
          echo "CONFIG_TARGET_x86_64_DEVICE_generic=y" >> .config
          echo "CONFIG_LUCI_LANG_zh_Hans=y" >> .config

      # 6. 启用 IPTables Cgroup 组件（核心配置）
      - name: Enable IPTables Cgroup
        run: |
          cd istoreos
          echo "CONFIG_kmod-ipt-cgroup=y" >> .config
          echo "CONFIG_iptables-mod-cgroup=y" >> .config
          echo "CONFIG_NETFILTER_XT_MATCH_CGROUP=y" >> .config

      # 7. 生成最终配置
      - name: Make Defconfig
        run: |
          cd istoreos
          make defconfig

      # 8. 导出完整配置文件（新增：方便查看所有选中的组件）
      - name: Export Full Config
        run: |
          cd istoreos
          # 把完整的.config文件复制到易访问的目录
          cp .config ../full_config.txt
          # 筛选出所有选中的包（组件/插件），生成简化清单
          grep -E "CONFIG_PACKAGE_|CONFIG_KERNEL_|CONFIG_LUCI_" .config | grep -v "#" > ../selected_packages.txt

      # 9. 下载依赖包（加速编译）
      - name: Download Packages
        run: |
          cd istoreos
          make download -j$(nproc)

      # 10. 开始编译固件
      - name: Build Firmware
        run: |
          cd istoreos
          make -j$(nproc) V=s

      # 11. 上传编译结果（包含固件、配置文件、清单文件）
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: iStoreOS-x86_64-Cgroup
          # 同时上传固件、完整配置、选中包清单、manifest文件
          path: |
            istoreos/bin/targets/x86/64/*.img.gz
            istoreos/bin/targets/x86/64/*.manifest
            full_config.txt
            selected_packages.txt
